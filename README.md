# Pet-project to show n + 1 Hibernate problem
Project contains several branches. Each branch contains implementation of a way to avoid n + 1 problem   
To check what is going on you just need to run NPlusOneProblemApplicationTests.shouldFetchAllTopics() in the debug mode and watch for the Hibernate SQL query output in the console and compare it between branches.


## What is n + 1 problem itself?
It's a problem when hibernate executes too many queries to fetch a data for nested entities.

**Hibernate introduces several ways how to fix that.**

## The first way is using EAGER FetchType parameter  
Limitations of this way are:
* You can't use EAGER fetch for a several collections declared in an Entity (Topic in particular)
* This is still not the solution due to Hibernate makes a set of calls in order to fetch a nested collection

## The second way is using @LazyCollection(LazyCollectionOption.FALSE) above nested collection
This way allows to bypass EAGER limitation but still performs too slow.
Actually it acts like and EAGER FetchType parameter but for multiple nested collections

## The third way is using @BatchSize annotation above the nested collection
One of the best way to handle nested collections

## The fourth way is using JOIN FETCH clause in a JPQL query
The tremendous disadvantage of this way is that the query generated for a several collections will produce cartesian product 
for multiple nested collections.

See JQPL query below and the appropriate SQL query generated by Hibernate.

JPQL query
```hql
select t from Topic t
  join fetch t.comments
  join fetch t.advertisements
where t.id = 1
```
Vanilla SQL query:
```sql
select * from topic t
  join comment c on t.id = c.topic_id
  join targeted_ads ta on t.id = ta.topic_id
where t.id = 1;
```
Based on data uploaded by liquibase in this project execution of vanilla SQL query will return 20 rows 
instead of 1 row for the Topic entity 2 rows for the TargetAdvertisement entity and 10 rows for the Comment entity.

## Bonus part hidden n + 1 problem while persisting huge amount of entities
Check the implementation in appropriate branch